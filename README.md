# DICOM Archive Tool (ditag)

A CLI tool for indexing, querying, and sending DICOM files.

## Installation

1.  Clone this repository.
2.  Install the required dependencies:

    ```bash
    pip install -r requirements.txt
    ```

3.  Install the `ditag` tool:

    ```bash
    pip install .
    ```

## Configuration

The `ditag` tool uses a configuration file located at `~/.ditag/config.ini` by default. The file is created automatically when you run the `index` command for the first time.

The configuration file has the following structure:

```ini
[DEFAULT]
database = /home/user/.ditag/dicom.db
archive_path = /mnt/archive

[PACS]
destination = 192.168.1.100
port = 104
aetitle = PACS_AE
myaet = DITAG
```

You can specify a different configuration file for any command using the `--config-file` option.

## Usage

### `index`

The `index` command scans a directory of DICOM files and stores their metadata in a database.

**Example 1: Index an archive**

This command will index the `/mnt/Archive/` directory, create a new database, and save the configuration.

```bash
ditag index --archive="/mnt/Archive/"
```

**Example 2: Append to an existing index**

This command will add the contents of `/mnt/Archive2/` to the existing database.

```bash
ditag index --archive="/mnt/Archive2/" --append
```

### `query`

The `query` command searches the indexed DICOM metadata.

**Arguments:**

*   `--sdate`: Start date for the search range (YYYYMMDD).
*   `--edate`: End date for the search range (YYYYMMDD).
*   `--date`: A specific date to search (YYYYMMDD).
*   `--targets`: A comma-separated list of DICOM tags to search (e.g., `StudyDescription`, `SeriesDescription`).
*   `--pattern`: A regular expression to match against the target tags.
*   `--output`: A file path to save the results in CSV format.

**Example 1: Search by date range and regex**

This command searches for series between the specified dates where the `SeriesDescription` or `StudyDescription` matches the regex pattern.

```bash
ditag query --sdate="19820111" --edate="19820112" --targets="SeriesDescription,StudyDescription" --pattern="^[A-z]+\sB[a-z]+s$"
```

The output will be a CSV formatted list of matching series printed to STDOUT.

**Example 2: Save results to a file**

This command performs the same query but saves the results to `results.txt`.

```bash
ditag query --sdate="19820111" --output=results.txt
```

### `send`

The `send` command sends DICOM files to a PACS destination.

**Arguments:**

*   `--input`: A CSV file containing the list of series to send (generated by the `query` command). If not provided, it reads from STDIN.
*   `--destination`: The IP address of the PACS.
*   `--port`: The port number of the PACS.
*   `--pacs-aetitle`: The AE Title of the PACS.
*   `--myaet`: Your local AE Title (defaults to `DITAG`).

**Example 1: Send from a file**

This command sends the series listed in `results.txt` to the specified PACS. The PACS information will be saved to the config file.

```bash
ditag send --input=results.txt --destination=152.11.105.71 --port=4242 --pacs-aetitle=RADIO-RIIPL
```

**Example 2: Send using a pipe**

This command queries for all series from a specific date and pipes the results directly to the `send` command, which sends them to the PACS destination defined in the config file.

```bash
ditag query --date="19820111" | ditag send
```